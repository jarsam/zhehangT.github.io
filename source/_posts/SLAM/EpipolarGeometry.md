---
title: 单目相机中的对极几何
date: 2017-03-5 10:11:25
tags:
- SLAM基础
- 对极几何
- 2D-2D
categories:
- 机器人事业
- SLAM
description: 关于学习SLAM问题中如果用对极几何来评估相机位姿的简单记录。
---
<!-- more -->

# 摘要
在图像特征匹配中我们提到，有了特征匹配，就可以估计相机的位姿变换，这个过程被称为对极几何。


# 对极几何
{% qnimg EpipolarGeometry-01.jpg title: 相机的位姿变换 alt: %}

假设相机由如图的位姿变换。$P$为空间中的某一点，在两幅图像中的像素坐标分别为$p\_1$和$p\_2$，在相机坐标系下的坐标为$c\_{1}$和$c\_{2}$，根据针孔相机中的坐标变换公式可知：
$z\_{1}p\_1=Kc\_{1}$
$z\_{2}p\_2=Kc\_{2}$
其中$z\_{1}$是$c\_{1}$在$Z$轴上的坐标，$z\_{2}$是$c\_{2}$在$Z$轴上的坐标，$K$是相机的内参矩阵。

由于$C\_0,C\_1,P$三点共面，所以有：
$\overrightarrow{C\_0 P} \cdot (\overrightarrow{C\_0 C\_1}\times \overrightarrow{C\_1 P}) = 0 \Rightarrow  c\_{1} \cdot (t\times Rc\_{2}) = 0 $
其中$R$为旋转矩阵，$t$为平移向量。

又因为两个向量的叉乘可以表示为第一个向量的反对称矩阵乘以另一个向量，因此上式可以转变为：
$ c\_{1}^T  [t]\_{\times} R c\_{2} = 0 $
其中$[t]\_{\times}$为反对称矩阵，具体形式为：
$[t]\_{\times}=\begin{bmatrix}
0 & -a\_3 & a\_2 \\\ 
a\_3 & 0 & -a\_1 \\\
-a\_2 & a\_1 & 0
\end{bmatrix}$

代入$p\_1$和$p\_2$可得：
$ p\_{1}^T K^{-T} [t]\_{\times} R K^{-1} p\_{2} = 0 $


一般用$E=[t]\_{\times} R$，称为**本质矩阵**(Essential Marix)。
一般用$F=K^{-T} [t]\_{\times} R K^{-1}$，称为**基础矩阵**(Fundamental Matrix)。
因此上式可以转变为：
$c\_{1}^T E c\_{2} = 0$
$p\_{1}^T F p\_{2} = 0$
这两个等式称为**对极约束**。

但是在2D-2D问题中，我们只有像素坐标$p\_{1}$和$p\_{2}$，$c\_{1}$和$c\_{2}$都是未知的，那该怎么办？
此时可以引入一个归一化坐标的概念。即令：
$
x\_1 = \dfrac{c\_1}{z\_1} = K^{-1}p\_1 \\\
x\_2 = \dfrac{c\_2}{z\_2} = K^{-1}p\_2
$

因此有：
$
x\_1Ex\_2=0
$
其中$x\_1$和$x\_2$可以从像素坐标$p\_1$和$p\_2$中求得。$E$和$F$之间存在转换关系：$F=K^{-T}EK^{-1}$


对极约束简洁地给出了两幅图像之间的空间位姿关系，于是相机位姿估计问题变为以下两步：
1.根据两幅图像的像素坐标，求出$E$或者$F$。
2.根据$E$或者$F$，求出$R$，$t$。

# 本质矩阵求解
本质矩阵相对于基础矩阵来说，相差一个相机的内参矩阵，在SLAM问题中，这个矩阵往往是已知的。因此在估计相机位姿变化时，通常求解形式相对简单的本质矩阵。

考虑一对匹配点的像素坐标$p\_1$为$[u\_1, v\_1, 1]$，$p\_2$为$[u\_2, v\_2, 1]$，则根据对极约束有:

$(u\_1, v\_1, 1)\begin{pmatrix}
e\_1 & e\_2 &  e\_3 \\\ 
e\_4 & e\_5& e\_6 \\\ 
e\_7 & e\_8& e\_9
\end{pmatrix}(u\_2, v\_2, 1)=0$

另$e=[e\_1, e\_2,...,e\_9]^T$，则上式可转化为：
$[u\_1u\_2, u\_1v\_2, u\_1, v\_1u\_2, v\_1v\_2, v\_1 , u\_2, v\_2, 1] \cdot e = 0$
对于这个线性方程，存在尺度等价性，即对$e$乘以任何常数，等式依旧成立。因此即使$e$有9个未知变量，只需要8个方程，构成线性方程组即可对$e$进行求解。这就是求解本质矩阵最经典的**八点法**。


旋转矩阵是一个正交矩阵，因此从本质矩阵恢复t和R通常对本质矩阵进行奇异值分解：
$E=U \Sigma V^T$
则：
$R=UR\_Z^T(\pm \frac{\pi}{2})V^T$
$[T]\_{\times}=U R\_Z^T(\pm \frac{\pi}{2}) \Sigma U^T$

其中$R\_Z^T(\pm \frac{\pi}{2})$表示绕Z轴旋转90度得到的旋转矩阵。
因此$R$,$T$共有4种组合情况。如图所示。
{% qnimg EpipolarGeometry-02.png title: ... alt:... %}
只有第一种解正确的，因为P点在两个相机中的深度都是为正的。因此只要把任意一点代入四种解中，检测该点在两个相机下的深度，就可以确定哪个解是正确的。

本质矩阵有几个非常重要的**特性** ：
1）基础矩阵是由对极约束定义的。由于对极约束是等式为零的约束，所以对$E$乘以任意非零常数后，对极约束依然满足。因此$E$具有不同尺度下的尺度等价性。
2）根据$E=[t]\_{\times}R$可以证明，本质矩阵E的奇异值必定是$[\sigma ,\sigma ,0]^T$的形式，这称为本质矩阵的内在性质。
3）由于平移和旋转各有三个自由度，故$[t]\_{\times}$共有6个自由度。但由于E具有尺度等价性，故$E$实际上有五个自由度。



因为一些误差的存在，通过8点法计算得到的本质矩阵$E$可能不会严格满足上述的特性2，因此通常会对奇异值矩阵做调整。通常的做法是，对八点法求得的E进行SVD分解后，会得到奇异值矩阵$\Sigma=\textbf{diag}(\sigma\_1, \sigma\_2, \sigma\_3)$。不妨设$\sigma\_1 \geq  \sigma\_2 \geq \sigma\_3$，取：
$E = U \textbf{diag}(\dfrac{\sigma\_1 + \sigma\_2}{2},\dfrac{\sigma\_1 + \sigma\_2}{2},0)$
由于$E$具有尺度等价性，因此更简单的做法是将奇异值矩阵取为$\textbf{diag}(1,1,0)$。





# 单应矩阵

除了基本矩阵和本质矩阵，还有一种单应矩阵(Homography)$H$，它描述了两个平面之间的映射关系。若场景中的特征点都落同一个平面上(比如墙，地面等)，则可以通过单应性来进行运动估计。

假设P在三维空间中的某个平面上，这个平面满足：
$n^TP+d=0$

则有：
$p\_2 = K(R-\dfrac{tn^T}{d})K^{-1}p\_1$

中间部分记为$H$，称为单应矩阵。于是
$p\_2 = Hp\_1$

单应矩阵的定义与旋转、平移以及平面的参数有关。对上式展开可得：

$\begin{pmatrix}
u\_2 \\\
v\_2 \\\ 
1 
\end{pmatrix}=\begin{pmatrix}
h\_1 & h\_2 &  h\_3 \\\ 
h\_4 & h\_5& h\_6 \\\ 
h\_7 & h\_8& h\_9
\end{pmatrix}\begin{pmatrix}
u\_1 \\\
v\_1 \\\ 
1 
\end{pmatrix}$

简单转换可得：
$u\_2 = \dfrac{h\_1 v\_1+h\_2 v\_1+h\_3}{h\_7 v\_1+h\_8 v\_1+h\_9}$

$v\_2 = \dfrac{h\_4 v\_1+h\_5 v\_1+h\_6}{h\_7 v\_1+h\_8 v\_1+h\_9}$

这样一组匹配点就可以构造2个方程。因为像素坐标为齐次坐标，所以单应矩阵乘以任意常数项，等式仍然成立。因此即使单应矩阵的未知变量为9个，但其自由度为8。因此需要4组匹配点，构造8个方程，来对单应矩阵进行求解。与本质矩阵相似，求出单应矩阵后需要对其进行分解，才可以得到相应的旋转矩阵R和平移向量t。

单应性在SLAM中具有重要意义。当特征点共面时或相机发生纯旋转时，基础矩阵的自由度下降，这就出现了所谓的退化。这时候继续用8点法求解基础矩阵会导致受到噪声的影响增加。为了避免这种情况，通常会同时估计基础矩阵F和单应矩阵H，选择重投影误差比较小的那个作为最终的运动估计矩阵。

# 讨论
首先由于$E$具有尺度等价性，因此它分解得到的$t$和$R$也有一个尺度等价性。而$R\in SO(3)$自身具有约束，因此可以认为$t$也具有尺度等价性。$t$的尺度等价性直接导致$t$的大小与现实世界中平移的大小并不是对应的。也就是说在单目SLAM中，每次都要确定$t$的尺度，通常的做法是对$t$进行归一化。这称为单目SLAM的**初始化**。初始化之后就可以用3D-2D来计算相机运动，初始化之后的轨迹和地图的单位，就是初始化时固定的尺度。
其次即使可以用单应矩阵来处理纯旋转的情况，但是由于纯旋转缺少位移，因此无法对空间点进行三角化。也就是说对于单目SLAM来说，初始化必须要有位移。
最后我们提到用8点法求解本质矩阵。但是实际中往往匹配点会远远多于8对，此时有两种求解思路。
当匹配正确率比较高的时候，可以构造最小二乘。
当匹配错误率比较高的时候，可以用随机采样一致性$\textrm{(RANSAC)}$求解。




# 参考文献
1. 《视觉SLAM十四讲》第七讲
2. [Monocular slam 的理论基础(1)](http://blog.csdn.net/heyijia0327/article/details/50758944)










